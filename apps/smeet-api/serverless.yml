service: smeet-api

plugins:
  - 'serverless-bundle'
  - serverless-appsync-plugin

package:
  individually: true

custom:
  stage: ${opt:stage, env:STAGE, 'dev'}
  bundle:
    linting: false
    tsConfig: 'tsconfig.app.json'
  appSync:
    name: ${self:provider.stage}-smeet-api
    authenticationType: API_KEY
    apiKeys:
      - name: default # name of the api key
        description: 'Default api key'
    schema:
      - ../../libs/shared/graphql/schema/_query.graphql
      - ../../libs/shared/graphql/schema/_subscription.graphql
      - ../../libs/shared/graphql/schema/_mutation.graphql
      - ../../libs/shared/graphql/schema/types.graphql
    dataSources:
      - type: AWS_LAMBDA
        name: listChats
        config:
          functionName: listChats
    mappingTemplates:
      - dataSource: listChats
        type: Query
        field: listChats
        request: false
        response: false

params:
  prod:
    production: true
  default:
    production: false

provider:
  name: aws
  region: eu-central-1
  runtime: nodejs18.x
  stage: ${self:custom.stage}
  timeout: 20
  deploymentBucket:
    name: ${ssm:/serverless/smeet-${self:provider.stage}/deployment-bucket}
  apiGateway:
    restApiId: ${ssm:/serverless/smeet-${self:provider.stage}/rest-api-id}
    restApiRootResourceId: ${ssm:/serverless/smeet-${self:provider.stage}/rest-api-root-resource-id}
  environment:
    APP_ENV: ${self:custom.stage}
    IS_PRODUCTION: ${param:production}
    NODE_OPTIONS: --enable-source-maps
    APP_SYNC_URL:
      Fn::GetAtt: [GraphQlApi, GraphQLUrl]
    APP_SYNC_API_KEY:
      Fn::GetAtt: [GraphQlApiKeydefault, ApiKey]

functions:
  getConfig:
    handler: src/handlers/config/getConfig.handler
    events:
      - http:
          method: GET
          path: /getConfig
  listChats:
    handler: src/handlers/chats/listChats.handler
